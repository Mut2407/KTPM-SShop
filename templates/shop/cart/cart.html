{% extends '../../base.html' %}
{% load static %}
{% block title %}Cart{% endblock title %}
{% block content %}

<div class="pages-title section-padding">
    <div class="container">
        <div style="background:#40394a" class="row">
            <div class="col-xs-12">
                <div class="pages-title-text text-center">
                    <h2 style="color:#f4cca4">Cart</h2>
                    <ul class="text-left">
                        <li><a style="color:#d99879" href="/">Home </a></li>
                        <li style="color:#d99879"><span> // </span>Cart</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% if not cart_items %}
<div style="font-size:18px; margin-bottom:300px;margin-top:30px" class="container alert alert-info text-center" role="alert">
    <b>Your Cart Is Empty,&nbsp;&nbsp; <a href="{% url 'shop:shop' %}" style="color:#21094e;text-decoration: underline;">Go To Shop<a></b>
</div>

{% else %}
<section style="background:#1c1427" class="pages cart-page section-padding">
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                <div style="border-radius:20px;" class="table-responsive padding60">
                    <table class="wishlist-table text-center">
                        <thead>
                            <tr>
                                <th style="border-radius:20px 0 0 20px;">Image</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total Price</th>
                                <th style="border-radius:0 20px 20px 0;">Remove</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cart_item in cart_items %}
                            <tr>
                                <td class="td-img text-center">
                                    <a href="{{cart_item.product.get_prodcut_details_url}}">
                                        <img style="border-radius:10px;" width="100" height="100" src="{{cart_item.product.image.url}}" alt="Add Product" />
                                    </a>
                                </td>
                                <td>
                                    <div class="items-dsc">
                                        <h5><a href="{{cart_item.product.get_prodcut_details_url}}">{{cart_item.product.name}}</a></h5>

                                        {% if cart_item.variation.all %}
                                            {% for item in cart_item.variation.all %}
                                            <p>{{item.variation_category | capfirst}} : {{item.variation_value | capfirst}}</p>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </td>
                                <td>${{cart_item.product.price}}</td>
                                <td>
                                    <div class="plus-minus">
                                        <button 
                                            style="background:#232323; color:#fff; height:35px; width:40px; border-radius: 4px; border:none; cursor:pointer; margin-right: 5px;" 
                                            onclick="updateCart({{ cart_item.id }}, 'decrease')">
                                            <i class="fa fa-minus"></i>
                                        </button>
                                        
                                        <input 
                                            style="height:35px; width:50px; text-align:center; display:inline-block; border-radius:4px; border: 1px solid #ccc;" 
                                            class="form-control" 
                                            value="{{cart_item.quantity}}" 
                                            readonly 
                                            id="qty-{{ cart_item.id }}"
                                        >
                                        
                                        <button 
                                            style="background:#232323; color:#fff; height:35px; width:40px; border-radius: 4px; border:none; cursor:pointer; margin-left: 5px;" 
                                            onclick="updateCart({{ cart_item.id }}, 'increase')">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <strong style="color:#f4cca4" id="subtotal-{{ cart_item.id }}">${{cart_item.sub_total}}</strong>
                                </td>
                                <td>
                                    <a href="{% url 'cart:remove_cart_item' cart_item.product.id cart_item.id %}">
                                        <i style="background:#ba135d;color:#f4cca4" onclick="return confirm('Are you really want delete this?')" class="mdi mdi-close"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <br><br><br>
                    
                    <div class="cart-form-text pay-details table-responsive">
                        <table>
                            <tbody style="color:#f4cca4">
                                <tr>
                                    <th style="font-size:18px">Cart Subtotal</th>
                                    <td style="font-size:18px" id="cart-total-price">${{total}}</td>
                                </tr>
                                <tr>
                                    <th style="font-size:18px">Shipping and Handing</th>
                                    <td style="font-size:18px">${{handing}}</td>
                                </tr>
                                <tr>
                                    <th style="font-size:18px">Vat</th>
                                    <td style="font-size:18px" id="cart-tax">${{vat}}</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th style="color:#d99879; font-size:22px" class="tfoot-padd">Order total</th>
                                    <td style="color:#d99879; font-size:22px" class="tfoot-padd" id="cart-grand-total">${{order_total}}</td>
                                </tr>
                            </tfoot>
                        </table>
                        <br><br><br>
                        <div class="list-btn text-center">
                            <a href="{% url 'orders:checkout' %}" class="btn" style="background:#f4cca4;color:#1c1427; text-transform:capitalize; font-size:18px; width:60%"><b>Checkout</b></a><br><br>
                            <a href="{% url 'shop:shop' %}" class="btn btn-warning" style=" background:none;color:#f4cca4; text-transform:capitalize; font-size:18px; width:60%">continue shopping</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <br>
    </div>
</section>
{% endif %}

<script>
    function updateCart(itemId, action) {
        var url = "{% url 'cart:update_cart_ajax' %}";

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                'cartItemID': itemId,
                'action': action
            })
        })
        .then((response) => response.json())
        .then((data) => {
            if (data.status === 'success') {
                document.getElementById('qty-' + itemId).value = data.item_qty;
                document.getElementById('subtotal-' + itemId).innerText = '$' + data.item_subtotal;
                document.getElementById('cart-total-price').innerText = '$' + data.cart_subtotal;
                document.getElementById('cart-tax').innerText = '$' + data.tax;
                document.getElementById('cart-grand-total').innerText = '$' + data.order_total;

                console.log('Cart updated successfully');
            } else {
                console.error('Error:', data.message);
                alert('Có lỗi xảy ra khi cập nhật giỏ hàng.');
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
</script>

{% endblock content %}